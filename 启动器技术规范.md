<!-- START doctoc generated TOC please keep comment here to allow auto update -->
<!-- DON'T EDIT THIS SECTION, INSTEAD RE-RUN doctoc TO UPDATE -->
目录
=================

- [概述](#%E6%A6%82%E8%BF%B0)
- [模型](#%E6%A8%A1%E5%9E%8B)
  - [Yggdrasil 服务端](#yggdrasil-%E6%9C%8D%E5%8A%A1%E7%AB%AF)
  - [登录信息](#%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF)
- [操作流程](#%E6%93%8D%E4%BD%9C%E6%B5%81%E7%A8%8B)
  - [登录到一个用户](#%E7%99%BB%E5%BD%95%E5%88%B0%E4%B8%80%E4%B8%AA%E7%94%A8%E6%88%B7)
  - [确认当前登录信息有效](#%E7%A1%AE%E8%AE%A4%E5%BD%93%E5%89%8D%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF%E6%9C%89%E6%95%88)
  - [退出登录](#%E9%80%80%E5%87%BA%E7%99%BB%E5%BD%95)
- [启动游戏](#%E5%90%AF%E5%8A%A8%E6%B8%B8%E6%88%8F)
  - [获取 authlib-injector](#%E8%8E%B7%E5%8F%96-authlib-injector)
  - [添加启动参数](#%E6%B7%BB%E5%8A%A0%E5%90%AF%E5%8A%A8%E5%8F%82%E6%95%B0)
    - [替换 minecraftArguments 中的变量](#%E6%9B%BF%E6%8D%A2-minecraftarguments-%E4%B8%AD%E7%9A%84%E5%8F%98%E9%87%8F)
    - [添加 JVM 参数](#%E6%B7%BB%E5%8A%A0-jvm-%E5%8F%82%E6%95%B0)
    - [配置预获取](#%E9%85%8D%E7%BD%AE%E9%A2%84%E8%8E%B7%E5%8F%96)
- [DnD 方式添加 Yggdrasil 服务端](#dnd-%E6%96%B9%E5%BC%8F%E6%B7%BB%E5%8A%A0-yggdrasil-%E6%9C%8D%E5%8A%A1%E7%AB%AF)
  - [拖动数据](#%E6%8B%96%E5%8A%A8%E6%95%B0%E6%8D%AE)
  - [HTML 示例](#html-%E7%A4%BA%E4%BE%8B)

<!-- END doctoc generated TOC please keep comment here to allow auto update -->

# 概述
本文旨在为启动器实现自定义 Yggdrasil 服务验证功能提供技术规范。由于实现该功能需要调用 Yggdrasil API，因此建议您在阅读本文前，先阅读 [Yggdrasil 服务端技术规范](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范)。

在本文中，假设启动器存储了若干个用户的登录信息，并且启动器是可以记住登录状态的。并且不同用户可以属于不同的 Yggdrasil 服务端。每次启动游戏时，玩家选择一个用户进行游戏。

本文中假定 Yggdrasil 服务端实现了[扩展 API](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#扩展-api)。

# 模型

## Yggdrasil 服务端
对于的 Yggdrasil 服务端，我们只需要以下信息就可以描述它：
 * Yggdrasil 服务端的 URL（即 API Root）

如果启动器需要显示服务器的名称，[`meta` 中的 `serverName`](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#服务端信息获取)将是一个不错的选择。

> 安全警告：
>   * 当服务端 URL 使用的不是 HTTPS 协议，而是明文的 HTTP 协议时，启动器应向用户给出警告，提醒用户密码会被明文传输。
>   * 即使启动器使用 `meta` 中的 `serverName` 作为服务器名称进行显示，也应在一旁注明服务端 URL，否则服务端可进行欺诈。

## 登录信息
> 安全警告：
>   * 记住登录状态**不是**存储用户的密码。密码在任何时候都**不应该**被明文存储。

要存储一个用户的登录信息，那么以下项目应该被记录：
 * 用户的邮箱
 * accessToken
 * clientToken
 * 该令牌绑定的角色的信息
   * 包含 UUID 和名称
 * 用户 ID
 * 用户的属性
 * 该用户所属的 [Yggdrasil 服务端](#yggdrasil-服务端)

# 操作流程
在本文中，所有[登录请求](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#登录)和[刷新请求](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#刷新)中的 `requestUser` 均为 `true`。
当收到响应时，启动器首先对比响应中的 `clientToken` 与存储的 `clientToken` 是否相同，若不同则触发异常。
并且在请求成功之后使用响应中的信息更新存储的登录信息，需要更新的信息如下：
 * accessToken
 * 绑定的角色的信息
 * 用户 ID
 * 用户的属性

## 登录到一个用户
玩家提供了邮箱和密码，以及它所属的 Yggdrasil 服务端，并且期望登录到这个账户。

 1. 随机生成一个 `clientToken`（无符号 UUID）
 2. 发送[登录请求](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#登录)，包含上述 `clientToken`
 3. 若响应中**不包含** `selectedProfile`，就需要选择角色
    1. 让玩家从 `availableProfiles` 中选择一个角色。若 `availableProfiles` 为空，则用户无任何角色，触发异常
    2. 发送[刷新请求](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#刷新)，其中 `selectedProfile` 为上一步所选择的角色

## 确认当前登录信息有效
该操作在启动游戏前进行，以确保传入 Minecraft 的登录信息可用。

 1. 发送[验证令牌请求](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#验证令牌)
 2. 若验证令牌操作返回 `ForbiddenOperationException` 异常，则需要刷新令牌
    1. 发送[刷新请求](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#刷新)，其中 `selectedProfile` 为空
    2. 若刷新操作返回 `ForbiddenOperationException` 异常，则令牌已失效。需要提示用户重新输入密码，然后按照[登录到一个用户](#登录到一个用户)处理
	    1. 若需要选择角色，则启动器从 `availableProfiles` 中选择 UUID 与原先角色 UUID 相同的那个角色
            * 若不存在这样一个角色，则该角色在服务端已被删除，触发异常
	    1. 若登录操作返回的 `selectedProfile` 的 UUID 与原先角色的 UUID 不同，则原先角色已不存在，触发异常

## 退出登录
该操作会使当前登录信息无效。

 1. 发送[吊销令牌请求](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#吊销令牌)
 2. 启动器删除存储的登录信息

# 启动游戏

## 获取 authlib-injector
启动器可以通过本项目的[下载 API](https://github.com/yushijinhun/authlib-injector/wiki/获取-authlib-injector) 获取最新版本的 authlib-injector。

## 添加启动参数

### 替换 minecraftArguments 中的变量
|变量名|替换为|
|------|------|
|auth_access_token|_令牌的 accessToken_|
|auth_session|_令牌的 accessToken_|
|auth_player_name|_角色名称_|
|auth_uuid|_角色的 UUID（无符号）_|
|user_type|mojang|
|user_properties|_角色的属性（JSON 格式）_|

### 添加 JVM 参数
需要添加以下 JVM 参数：
```
-javaagent:{authlib-injector.jar 的路径}={Yggdrasil 服务端的 URL（API Root）}
```

例如：

```
-javaagent:/home/user/.minecraft/authlib-injector.jar=https://example.yggdrasil.yushi.moe/
```

### 配置预获取
authlib-injector 会在启动时从 Yggdrasil 服务端获取配置，这可能会影响启动速度。
启动器可以在启动游戏前就预先请求 API Root，将响应保存，并在启动时通过以下 JVM 参数指定：
```
-Dorg.to2mbn.authlibinjector.config.prefetched={Base64 编码后的 API Root 响应}
```
以上参数是可选的。如果指定了以上参数，则 authlib-injector 会将参数的值进行 Base64 解码后当做 API Root 的响应。

# DnD 方式添加 Yggdrasil 服务端
> 注意：这是一个非必须实现的功能。

用户向启动器中添加 Yggdrasil 服务端时需要输入 API Root，这很不便且容易出错。此项规范规定了一种通过 [DnD (Drag and Drop)](https://developer.mozilla.org/en-US/docs/Web/API/HTML_Drag_and_Drop_API) 来向启动器添加 Yggdrasil 服务端的方式，旨在避免手动输入 URL，以简化用户操作。

DnD 源可以是浏览器或者其他应用程序，而 DnD 目标则是启动器。DnD 源需要展示一段文字、图片或其他内容，示意用户将此内容拖入启动器，以添加 Yggdrasil 服务端。在此过程中，Yggdrasil 服务端的信息从 DnD 源传输到启动器。在完成 DnD 动作后，启动器向用户确认是否要添加此 Yggdrasil 服务器。

## 拖动数据
拖动数据的 MIME 类型为 `text/plain`，内容为一段 URI，其格式如下：

```
authlib-injector:yggdrasil-server:{Yggdrasil 服务端的 URL（API Root）}
```
其中 API Root 是 URI 的一个组成，应当被[编码](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/encodeURIComponent)。

拖动效果为复制（`copy`）。

## HTML 示例
> [演示页面](https://rawgit.com/wiki/yushijinhun/authlib-injector/yggdrasil-server-dnd-example.html)

在需要拖动的 DOM 节点上添加 `draggable="true"`，并处理 `dragstart` 事件：
```html
<span id="dndLabel" draggable="true" ondragstart="dndLabel_dragstart(event);">example.yggdrasil.yushi.moe</span>
```

```javascript
function dndLabel_dragstart(event) {
	let yggdrasilApiRoot = "https://example.yggdrasil.yushi.moe/";
	let uri = "authlib-injector:yggdrasil-server:" + encodeURIComponent(yggdrasilApiRoot);
	event.dataTransfer.setData("text/plain", uri);
	event.dataTransfer.dropEffect = "copy";
}
```

# API 地址指示 [proposed]
> 该规范处于 proposed 状态，将来可能有较大改动。

> 注意：这是一个非必须实现的功能。

关于此规范的详情，请阅读 [Yggdrasil 服务端技术规范](https://github.com/yushijinhun/authlib-injector/wiki/Yggdrasil服务端技术规范#api-地址指示-proposed)。

## 添加 Yggdrasil 服务端流程
1. 用户在启动器中输入一个 URL，并期望将其添加为 Yggdrasil 服务端
2. 启动器向该 URL 发出 GET 请求
3. 无论 HTTP 状态码是多少，启动器检查响应中是否包含 `X-Authlib-Injector-API-Indication` 头。如果存在，则继续向下执行；如果不存在，则将此 URL 作为 API Root
4. `X-Authlib-Injector-API-Indication` 的值可以是绝对 URL，也可以是相对 URL。若其为相对 URL，则启动器将其转换为绝对 URL（相对于原 URL）
5. 除去末尾斜杠 `/`，若新 URL 与原 URL 相同，则将其中任一项作为 API Root；若不相同，则继续向下执行
6. 启动器向新 URL 发出 GET 请求
7. 若响应不包含 `X-Authlib-Injector-API-Indication` 头，或者 `X-Authlib-Injector-API-Indication` 头所指的 URL 与新 URL 相同（同 4、5 步），则将新 URL 作为 API Root；若不同，则为重复重定向，触发异常

## 注意事项
1. API 地址指示仅用于确定 Yggdrasil 服务端的 API Root，其仅在添加 Yggdrasil 服务端时有效
2. 启动器应显示真实的 API Root，而不是重定向前的

# 地址协议补全 [proposed]
> 该规范处于 proposed 状态，将来可能有较大改动。

> 注意：这是一个非必须实现的功能。

当用户输入 Yggdrasil 服务器地址时，`https://` 前缀可以被省略，启动器自动补全协议部分。

为防止降级攻击，即使无法通过 HTTPS 协议连接，启动器也**不得**使用明文的 HTTP 协议重新连接。

为了防止误导用户，启动器应通过某些方式告知用户：若省略协议部分，地址将被补全为 HTTPS 协议而非 HTTP 协议。
