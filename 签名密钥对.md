目录
=================

   * [概述](#概述)
   * [密钥对的生成和处理](#密钥对的生成和处理)
      * [生成私钥](#生成私钥)
      * [从私钥生成公钥](#从私钥生成公钥)
      * [将DER格式公钥转换为PEM格式](#将der格式公钥转换为pem格式)

# 概述
本文主要介绍Yggdrasil中用于数字签名的密钥对。文中将使用OpenSSL对密钥进行操作。

Yggdrasil服务端持有私钥，而客户端持有公钥。

服务端会对以下请求的响应中的角色属性进行[数字签名](https://github.com/to2mbn/authlib-injector/wiki/Yggdrasil%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%80%E6%9C%AF%E8%A7%84%E8%8C%83#%E8%A7%92%E8%89%B2%E4%BF%A1%E6%81%AF%E7%9A%84%E5%BA%8F%E5%88%97%E5%8C%96)：
 * [服务端验证客户端](https://github.com/to2mbn/authlib-injector/wiki/Yggdrasil%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%80%E6%9C%AF%E8%A7%84%E8%8C%83#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E9%AA%8C%E8%AF%81%E5%AE%A2%E6%88%B7%E7%AB%AF)
 * [查询角色信息](https://github.com/to2mbn/authlib-injector/wiki/Yggdrasil%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%80%E6%9C%AF%E8%A7%84%E8%8C%83#%E6%9F%A5%E8%AF%A2%E5%8D%95%E4%B8%AA%E8%A7%92%E8%89%B2)（仅当`unsigned=false`时才需要）

服务端通过[扩展API](https://github.com/to2mbn/authlib-injector/wiki/Yggdrasil%E6%9C%8D%E5%8A%A1%E7%AB%AF%E6%8A%80%E6%9C%AF%E8%A7%84%E8%8C%83#%E6%9C%8D%E5%8A%A1%E7%AB%AF%E4%BF%A1%E6%81%AF%E8%8E%B7%E5%8F%96)将公钥公开，以便authlib-injector自动获取。

注意：Yggdrasil服务端应避免密钥的变化（不要每次启动时都生成一个，应在生成后将其保存）。
但不同的Yggdrasil服务不应使用同一个密钥。
如果使用多个服务端实例进行负载均衡，那么它们应该使用同一个密钥。

# 密钥对的生成和处理
下面对OpenSSL的调用都是使用标准输入和标准输出进行输入输出的。
如果要使用文件，可使用参数`-in <file>`和`-out <file>`。

## 生成私钥
密钥算法为RSA，且长度至少为4096位。

```
openssl genrsa 4096
```

生成的私钥将输出到标准输出。

私钥需要妥善保存，以防泄露（文件权限应为`rw-r-----`）。

## 从私钥生成公钥
```
openssl rsa -pubout
```

私钥从标准输入读入，公钥将输出到标准输出。

## 将DER格式公钥转换为PEM格式
authlib-injector使用的是PEM格式的公钥。
如果您有一个DER格式的公钥（如authlib-agent生成的），您可以通过以下命令转换：

```
openssl rsa -pubin -inform der
```

DER格式公钥从标准输入读入，PEM格式公钥将输出到标准输出。
